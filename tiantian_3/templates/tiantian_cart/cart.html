{%extends 'base_user.html'%}

{%block header%}
<script>
	function make_total() {
        var $total_all = 0;
	    $('.cart_list_td').each(function () {
//	        页面加载完自动循环
			var $count = parseInt($(this).find('.num_show').val());
			var $price = parseFloat($(this).find('.col05').children('span').text());
			var $total = $count * $price;
			$(this).children('.col07').text($total.toFixed(2)+'元');
    //	    计算总价
            if($(this).find('input').prop('checked')){
                $total_all+=$total;
            }
        });
	    $('.settlements').children('.col03').children('em').text($total_all.toFixed(2)); // 总金额
        $('.settlements').children('.col03').find('b').text($(':checked:not(#checked_all)').length); // 选中商品数量
        $('.total_count').children('em').text($('.cart_list_td').length); // 全部商品数量
    }
	$(function () {
	    make_total();
        $('.num_show').blur(function () {
//		判断数量框是否为小数，大于库存，小于０，是不是数字
			var $count = parseInt($(this).val());
			var $price = parseFloat($(this).closest('.col06').siblings('.col05').children('span').text());
			var $has = parseInt($(this).closest('.col06').attr('value'));
			if($count <= 0){
			    $count = 1;
			}
			else if($count > $has){
			    $count = $has;
			}
			else if(isNaN($count)){
			    $count = 1;
			}
            var $total = $count　* $price;
            $(this).val($count);
            $(this).closest('.col06').siblings('.col07').children('span').text($total.toFixed(2));
			$.post('/cart/edit/', {'c_id': $(this).closest('.cart_list_td').attr('id'), 'count': $count}, function
				(data) {
			    if(data.ok==1){
			        make_total();
				}
				else{
			        alert('添加购物车失败！')
				}

            });
        });
//		加一个
        $('.add').click(function () {
            var $count = parseInt($(this).next().val());
            var $price = parseFloat($(this).closest('.col06').siblings('.col05').children('span').text());
            $count++;
			$(this).next().val($count);
			$(this).next().blur();
        });
//		减一个
        $('.minus').click(function () {
            var $count = parseInt($(this).prev().val());
            var $price = parseFloat($(this).closest('.col06').siblings('.col05').children('span').text());
            $count--;
            $(this).prev().val($count);
            $(this).prev().blur();
        });
//        删除一个购物车商品
        $('.cart_list_td').children('.col08').click(function () {
            $(this).closest('.cart_list_td').remove();
			$.post('/cart/delete_cart/', {'c_id': $(this).closest('.cart_list_td').attr('id')}, function (data) {
			    if(data.ok == 1){
			        make_total();
			        $('.total_count').children('em').text(data.cart_len);
			        $('.settlements').children('.col03').children('b').text(data.cart_len);
				}
				else{
			        alert('删除失败，请重试！')
				}

            })
        });

//        全选功能
        $('#checked_all').click(function () {
            var $status = $(this).prop('checked');　// 原本为选中，点击之后变为不选中
            $(':checkbox:not(#checked_all)').prop({'checked': $status});
            $('.num_show').blur();
        });
//        有一个不选中，全选功能就变为不选中
        $(':checkbox:not(#checked_all)').click(function () {
            $(':checkbox:not(#checked_all)').each(function (i, n) {
                if($(this).prop('checked')==false){
                    $('#checked_all').prop({'checked': false});
                    return false;
				}
                $('#checked_all').prop({'checked': true});
            });
            $('.num_show').blur();
        });

//        提交订单，把选中的购物车id，传入后台
    })
</script>
{%endblock header%}

{%block body%}

	<div class="total_count">全部商品<em>0</em>件</div>
	<ul class="cart_list_th clearfix">
		<li class="col01">商品名称</li>
		<li class="col02">商品单位</li>
		<li class="col03">商品价格</li>
		<li class="col04">数量</li>
		<li class="col05">小计</li>
		<li class="col06">操作</li>
    <form action="/order/" method="post">
        {%csrf_token%}
        {%for i in cart_list%}
        <ul class="cart_list_td clearfix" id="{{i.id}}">
            <li class="col01"><input type="checkbox" name="check_cart" checked value="{{i.id}}"></li>
            <li class="col02"><img src="/static/{{i.c_goods.g_pic}}"></li>
            <li class="col03">{{i.c_goods.g_name}}<br><em>{{i.c_goods.g_price}}元/{{i.c_goods.g_unit}}</em></li>
            <li class="col04">{{i.c_goods.g_unit}}</li>
            <li class="col05"><span>{{i.c_goods.g_price}}</span>元</li>
            <li class="col06" value="{{i.c_goods.g_has}}">
                <div class="num_add">
                    <a href="javascript:;" class="add fl">+</a>
                    <input type="text" class="num_show fl" value="{{i.c_count}}">
                    <a href="javascript:;" class="minus fl">-</a>
                </div>
            </li>
            <li class="col07"><span>0</span>元</li>
            <li class="col08"><a href="javascript:;">删除</a></li>
        </ul>
        {%endfor%}

        <ul class="settlements">
            <li class="col01"><input type="checkbox" checked="checked" id="checked_all"></li>
            <li class="col02">全选</li>
            <li class="col03">合计(不含运费)：<span>¥</span><em>0</em><br>共计<b>0</b>件商品</li>
            <li class="col04"><input type="submit" value="去结算"></li>
        </ul>
    </form>

{%endblock body%}
